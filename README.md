# Hydrology-Flood-Response-Game

Hydrology-inspired **serious game** for **flood response decision-making** with an **AI advisor** (ML surrogate transition + **CVaR** risk-sensitive recommendation).

**GitHub repository:** `https://github.com/StephanieHsu0/Hydrology-Flood-Response-Game`  
**Live demo (Vercel):** `https://hydrology-flood-response-game.vercel.app/`

中文正式名稱：**城市指揮官：洪水應變 (City Commander: Flood Response)**  
定位：玩家扮演城市應變指揮官，在 **24 小時降雨事件**中進行資源配置與區域決策，目標是在有限預算下把損害降到最低並維持民眾信任。

---

## Game overview (玩法與規則摘要)

### Zones (三大分區)
- **Industrial（工業區）**：經濟權重最高，淹水損失最大  
- **Residential（住宅區）**：人口密集，淹水會大幅影響信任度  
- **Lowland（低窪區）**：地勢最差，最容易先淹

### Trust system（信任度 = 生命值）
- 初始 **100%**
- **嚴重淹水**（risk > 0.85）會扣信任
- **財政危機/赤字**行動會有額外懲罰
- 信任度歸零 → **Game Over**

### Budgeting（動態預算）
- **單區**行動：標準成本  
- **全區**行動：成本為單區的 **2.5 倍**  
- **週期性補助**：每 6 小時補助，金額與信任度相關  
- **緊急預算 funding**：補錢但扣信任（救命用）

### Actions（指令）
`none`, `alert`, `pump`, `diversion`, `evac`, `funding`（部分需指定目標區域）

---

## Project structure

```text
.
├── code/
│   ├── backend/                  # FastAPI backend + game simulation + AI advisor
│   ├── frontend/                 # Next.js UI
│   ├── data/                     # Rainfall scenarios + scenario parameters
│   ├── docs/                     # API + rules + scenario docs
│   └── model/                    # Training scripts + saved surrogate artifacts
└── REPORT.md                     # (local only) report draft, ignored by .gitignore
```

---

## AI core (Novelty & Technical Depth)

### 1) MDP formulation（馬可夫決策過程）
This game is modeled as an MDP for sequential decision-making under uncertainty:
- **State**: zone storages, derived risks, budget, trust, cooldowns, timestep/rain index
- **Action**: (action type) + optional target zone
- **Transition**: storage evolves with rainfall and mitigation effect (surrogate predicted)
- **Reward**: negative proxy of (damage + action cost) with trust penalties under critical flooding

### 2) ML surrogate model（機器學習代理模型）
To keep gameplay real-time, the backend predicts next-hour storage via an MLP surrogate:
- **Input features (6)**: \([S_t, Rain_t, Effect(a_t), a, b, c]\)
- **Model**: scikit-learn `MLPRegressor` (hidden layers: 64, 32)
- **Artifacts**: `code/model/surrogate_model.pkl`, `code/model/scaler.pkl`
- **Fallback**: if artifacts are missing, backend falls back to a deterministic formula

### 3) Risk-sensitive recommendation（CVaR 決策引擎）
Instead of minimizing average loss, the AI advisor optimizes **CVaR** (tail risk):
- **Horizon**: next **3 hours**
- **Uncertainty**: Monte Carlo rainfall perturbation (uniform factor in \([0.6, 1.4]\))
- **Objective**: minimize **CVaR\_{0.8}** (worst 20% expected loss)

### 4) Explainable AI（XAI）
Each recommendation returns:
- **Reason (json)**: summary + risk focus + budget note
- **Confidence**: derived from dispersion of simulated losses
- **Top reasons**: concise bullet explanations for UI display

---

## Quick start

### Backend (FastAPI)

```bash
cd code/backend
python -m venv .venv
.\.venv\Scripts\activate
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8000
```

### Frontend (Next.js)

```bash
cd code/frontend
npm install
npm run dev -- --port 3001
```

Open `http://localhost:3001`

---

## Model training (optional, for developers)

### Generate training data (local-only)
`code/model/training_data.csv` is generated by `data_gen.py` and is ignored by git.

```bash
python code/model/data_gen.py
```

### Retrain the surrogate and overwrite artifacts

```bash
python code/model/train.py
```

---

## Notes on generated files (what to commit vs. what to ignore)

- **Do not commit**: `code/frontend/node_modules/`, `code/frontend/.next/`, `code/backend/.venv/`, `__pycache__/`
- **Do not commit**: `REPORT.md` / `report.pdf` (already ignored by `.gitignore`)
- **Training dataset**: `code/model/training_data.csv` is generated by `code/model/data_gen.py` and is ignored by `.gitignore`

---

## Documentation

- API: `code/docs/API.md`
- Rules: `code/docs/game_rules.md`

